# Инструкция

## Порядок заведения метрик
### 1. Определиться с источником

- Конфиг источников: sources.yaml
- Лучше переиспользовать один из существующих
- Если нужен новый источник, то необходимо прописать его метаданные в конфиге по аналогии

### 2. Объявить метрику в конфиге

- Конфиги метрик в папке `metrics`
- ~~Для каждого источника — свой файл с метриками. Имя файла == имя источника~~
- ~~Все данные для одной метрики обязаны находиться в одном источнике~~
- Синтаксис объявления метрик описан ниже

##### UPD
Теперь имена конфигов метрик не обязаны совпадать с именем источника
Связь метрик с источником прописывается в sources.yaml двумя способами:
1. С помощью списка metric_configs, в котором указываются имена файлов с конфигами
2. С помощью списка metrics с явным перечислением метрик

Одна и та же метрика может быть привязана к разным источникам.
Но в рамках одной базы это крайне нежелательная конфигурация, т. к. при расчете АБ и M42
источник будет выбран в алфавитном порядке.
Возможность привязать метрику к разным источникам сделана для заведения источников в clickhouse,
и использовать метрики, изначально заводившиеся для Вертики.

### 3. Валидировать и создать PR
- Можно протестировать локально, выполнив `python validate.py`. Если есть ошибки, скрипт выведет их консоль
- Запушить ветку / создать PR. Билд валидации запустится автоматически
- PR попросить смерджить в #ab-central-help
------

## Порядок заведения дименшенов

Новые дименшены заводятся, чтобы иметь возможность добавлять их в слайсы (брейкдауны) АБ,
или в столбцы M42 (что делается реже и, ввиду большого выходного объема, — под присмотром DWH).

1. Добавить новый дименшен в dimensions.yaml по аналогии с уже заведенными дименшенами. Синтаксис описан ниже.
2. Добавить значения дименшенов в витрину dma.metrics_dimension_value (также по аналогии).

Очень желательно, чтобы у дименшена был айдишник, а не только varchar-представление.

------
## Синтаксис

### Дименшены
Конфиг `dimensions.yaml`. Ключом является общепринятый слаг дименшена.
- `level` — откуда берется дименшен. _event_ — из источника, _participant_ приджойнивается из _participant_dimension_.
  Есть еще _buyer_segment_ и _ab_participant_. Эта область не автоматизирована, джоины прописаны руками в коде сборки АБ и M42.
  Самый простой и распространенный вариант — _event_.
- `parent` — ключ дименшена, который считается родительским. Например, _vertical_ для _logical_category_.
- `is_bool` — флаг, что дименшен имеет тип boolean 
- `m42_has_any` — признак того, что в M42 для этого дименшена нужно считать аккумулятор Any. Обычно надо всегда,
  но если дименшен аддитивен по любой метрике, то можно поставить False. К таким дименшенам относится например is_human. 
- `m42_cartesian_default` — булев признак того, что дименшен должен добавляться во все декартовы группы m42.

### Источники
Конфиг `sources.yaml`
- `table` — имя таблицы (или вью). Обязательное поле
- `column_map` — маппинг наименований из конфигов метрик на колонки в таблице  
- `dimensions` — список дименшенов (ключи из dimensions.yaml), которые есть в источнике
- `participant` — маппинг, какой столбец отвечает за visitor, а какое за user (обычно cookie_id и user_id). Обязательное поле
- `dtm` — колонка с датой/таймстампом. Обязательное поле
- `segm` — колонка, по которой сегментирована таблица. Например для hash(cookie_id) нужно указать cookie_id. 
  Если сегментация таблицы не совпадает ни с одним из _participant_, то можно ничего не указывать. Скоро будет deprecated
- `database` — vertica или clickhouse
- `m42_cartesian_groups` — набор групп (список списков) дименшенов, для которых нужно рассчитывать цепочку value-value в M42.


### Метрики
Конфиги в папке `metrics`.

Метрики делятся на три типа. Каждый — в отдельном блоке конфига.
1. Простые каунтеры `metric.counter`. Аргументы:
    - `filter`: условие, фильтрующее нужные строки, перед тем как их сложить. Синтаксис описан в следующем разделе
    - `obs`: колонка (или список), значения которой нужно складывать. Если не указана, то подставляется 1
2. Уники `metric.uniq`. Аргументы:
    - `counter`: имя каунтера из первого блока.
    - `key`: колонка (или список), уникальные значения которой мы считаем. Если не указана, то подставляется participant
    - `threshold`: порог, по которому учитываем уника при условии sum(counter) > threshold. Если не указан, то 0.
3. Ratio: `metric.ratio`. Оба аргумента — ссылки на существующие метрики из пп. 1-2.
    - `num`: числитель
    - `den`: знаменатель

К метрикам можнод добавить параметр `m42: False`, и тогда метрика не будет считаться в M42. Это нужно, если например каунтер необходим для расчета уников, но сам по себе не очень полезный. Или для сугубо технических метрик, которые имеют смысл только в АБ.

### Синтаксис каунтеров
Условие в фильтре имеет формат ключ-значение. Ключом является имя столбца в источнике. В поле `obs` указываются столбцы, которые нужно сложить. Например, метрику с конфигом
`phone_views: {filter: [eid: 303], obs: [events_count]}` в SQL можно вычислить как `select sum(events_count) as phone_views from source where eid = 303`.

К столбцам в фильтре можно применять операторы. Оператор применяется через точку.

|Оператор|Примеры|Аналог в SQL|
|:---|:----|:----|
|`=, !=, <=, >=, <, >` |`a.>=: 1`|`a >= 1`|
|`in, !in`|`a.in: [1, 2, 3]`|`a in (1, 2, 3)`|
|`bit, !bit`|`a.bit: 5, a.bit: [4, 5]`|`a & (1 << 5) > 0, (a & (1 << 4) > 0 or a & (1 << 5) > 0)`|
|`isnull`|`a.isnull: true, a.isnull: false`|`a is null, a is not null`|

Условия в фильтре объявляются через запятую, а потом преобразуются в SQL через `and`. Для более сложных выражений существует ключевое слово `$or`.

Пример конфига:
```yaml
filter: [x_eid: 300, $or: [platform_id.!=: 1, flags.!bit: 4]]
```
Аналог в SQL:
```sql
where x_eid = 300 and (platform_id != 1 or flags & (1 << 4) = 0)
```

Допускается использовать вложенные `$or`.


### Definitions
Для упрощения кода в конфиге можно часто используемые конструкции объявить заранее, а потом использовать ссылки на них. Для этого используется синтаксис [якорей YAML](https://support.atlassian.com/bitbucket-cloud/docs/yaml-anchors/).

Пример:
```yaml
definitions:
  - &eid_search   [300]
  - &eid_rec      [2437, 2012, 2309]
  - &x_is_search  {x_eid: *eid_search}  # ссылка на якорь eid_search, объявленный в первой строке
  - &x_is_rec     {$or: [[x_eid: *eid_rec], [x_engine: sg-rec]]}

metric.counter:
  rec_events: {filter: *x_is_rec}
```
